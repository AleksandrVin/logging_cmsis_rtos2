# –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –æ—Ç–ª–∞–¥–∫–∞ –≤—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã—Ö —Å–∏—Å—Ç–µ–º STM32 —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º QEMU —ç–º—É–ª—è—Ç–æ—Ä–∞ –∏ Docker

## –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

–°—Ç–∞—Ç—å—è –±—É–¥–µ—Ç –ø–æ–ª–µ–∑–Ω–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞–º –≤—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã—Ö —Å–∏—Å—Ç–µ–º, –∫–æ—Ç–æ—Ä—ã–µ —Ö–æ—Ç—è—Ç –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ü–µ—Å—Å —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–≤–æ–∏—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤. –û—Ç–¥–µ–ª—å–Ω—ã–π –±–ª–æ–∫ –ø–æ—Å–≤–µ—â–µ–Ω –æ—Ç–ª–∞–¥–∫–µ `gdb` –≤ —ç–º—É–ª—è—Ç–æ—Ä–µ QEMU. –í –∫–∞—á–µ—Å—Ç–≤–µ –ø—Ä–∏–º–µ—Ä–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è ([GitHub](https://github.com/AleksandrVin/logging_cmsis_rtos2), [Habr](https://habr.com/ru/articles/814745/)), –Ω–æ –æ–ø–∏—Å–∞–Ω–Ω—ã–π –ø–æ–¥—Ö–æ–¥ –ø—Ä–∏–º–µ–Ω–∏–º –∫ –ª—é–±—ã–º –ø—Ä–æ–µ–∫—Ç–∞–º –Ω–∞ –±–∞–∑–µ STM32.

## –í–≤–µ–¥–µ–Ω–∏–µ

–ü—Ä–∏ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ –≤—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã—Ö —Å–∏—Å—Ç–µ–º —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —á–∞—Å—Ç–æ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è —É–∑–∫–∏–º –º–µ—Å—Ç–æ–º –ø—Ä–æ—Ü–µ—Å—Å–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏. –û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –≤–∫–ª—é—á–∞—é—Ç:

- **–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç –∂–µ–ª–µ–∑–∞:** –ù–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç—å –∏–º–µ—Ç—å —Ñ–∏–∑–∏—á–µ—Å–∫–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞ –∏ CI-—Å–µ—Ä–≤–µ—Ä–∞
- **–°–ª–æ–∂–Ω–æ—Å—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏:** –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ–∞–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –∫ CI-—Å–∏—Å—Ç–µ–º–∞–º —Ç—Ä–µ–±—É–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
- **–í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º–æ—Å—Ç—å —Ç–µ—Å—Ç–æ–≤:** –¢–µ—Å—Ç—ã –Ω–∞ —Ä–µ–∞–ª—å–Ω–æ–º –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–∏ –º–æ–≥—É—Ç –¥–∞–≤–∞—Ç—å —Ä–∞–∑–ª–∏—á–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏–∑-–∑–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫ –∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞

–í —ç—Ç–æ–π —Å—Ç–∞—Ç—å–µ —Ä–∞—Å—Å–º–æ—Ç—Ä–∏–º –ø–æ–¥—Ö–æ–¥ –∫ —Ä–µ—à–µ–Ω–∏—é —ç—Ç–∏—Ö –ø—Ä–æ–±–ª–µ–º —Å –ø–æ–º–æ—â—å—é —ç–º—É–ª—è—Ç–æ—Ä–∞ QEMU –∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏–∑–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ Docker. –í –∫–∞—á–µ—Å—Ç–≤–µ –ø—Ä–∏–º–µ—Ä–∞ –≤–æ–∑—å–º–µ–º –±–∏–±–ª–∏–æ—Ç–µ–∫—É –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è STM32, –Ω–æ –æ–ø–∏—Å–∞–Ω–Ω—ã–µ –º–µ—Ç–æ–¥—ã –ø—Ä–∏–º–µ–Ω–∏–º—ã –∫ –ª—é–±—ã–º –ø—Ä–æ–µ–∫—Ç–∞–º –Ω–∞ –±–∞–∑–µ —ç—Ç–æ–≥–æ –º–∏–∫—Ä–æ–∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞. –û—Å–æ–±–µ–Ω–Ω–æ —ç—Ç–æ –∞–∫—Ç—É–∞–ª—å–Ω–æ –¥–ª—è —É–¥–∞–ª–µ–Ω–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏.

–í –æ–ø–∏—Å—ã–≤–∞–µ–º–æ–º –ø–æ–¥—Ö–æ–¥–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –æ—Ç–∫—Ä—ã—Ç—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –∏ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏, —á—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –ª–µ–≥–∫–æ –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –Ω—É–∂–¥—ã –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤ –∫–æ–º–º–µ—Ä—á–µ—Å–∫–∏—Ö –ø—Ä–æ–µ–∫—Ç–∞—Ö.

### –ß—Ç–æ –≤—ã —É–∑–Ω–∞–µ—Ç–µ –∏–∑ —Å—Ç–∞—Ç—å–∏

1. [–ö–∞–∫ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å —Å–∏—Å—Ç–µ–º—É —Å–±–æ—Ä–∫–∏ –∏ —ç–º—É–ª—è—Ü–∏–∏](#—Å–∏—Å—Ç–µ–º–∞-—Å–±–æ—Ä–∫–∏-–≤-docker-–∏-—ç–º—É–ª—è—Ç–æ—Ä-qemu) —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º Docker –∏ QEMU
2. [–ö–∞–∫ –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç](#—Ç–µ—Å—Ç–æ–≤—ã–π-–ø—Ä–æ–µ–∫—Ç) –Ω–∞ –±–∞–∑–µ STM32CubeMX
3. [–ö–∞–∫ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ](#–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ-—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ) STM32 –ø—Ä–æ–µ–∫—Ç–æ–≤
4. [–ö–∞–∫ –æ—Ç–ª–∞–∂–∏–≤–∞—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ](#–æ—Ç–ª–∞–¥–∫–∞-—Å-–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º-gdb-–∏-qemu) –≤ —ç–º—É–ª—è—Ç–æ—Ä–µ

## –°–∏—Å—Ç–µ–º–∞ —Å–±–æ—Ä–∫–∏ –≤ Docker –∏ —ç–º—É–ª—è—Ç–æ—Ä QEMU

### –ü–æ—á–µ–º—É Docker?

–ü—Ä–∏ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ –≤—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã—Ö —Å–∏—Å—Ç–µ–º –º—ã —á–∞—Å—Ç–æ —Å—Ç–∞–ª–∫–∏–≤–∞–µ–º—Å—è —Å –ø—Ä–æ–±–ª–µ–º–æ–π "—É –º–µ–Ω—è —Ä–∞–±–æ—Ç–∞–µ—Ç". –≠—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –∏–∑-–∑–∞ —Ä–∞–∑–ª–∏—á–∏–π –≤:

- –í–µ—Ä—Å–∏—è—Ö –∫–æ–º–ø–∏–ª—è—Ç–æ—Ä–∞
- –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö –±–∏–±–ª–∏–æ—Ç–µ–∫–∞—Ö
- –ù–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è

Docker —Ä–µ—à–∞–µ—Ç —ç—Ç–∏ –ø—Ä–æ–±–ª–µ–º—ã, –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è—è –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—É—é —Å—Ä–µ–¥—É —Å —Ç–æ—á–Ω–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–º–∏ –≤–µ—Ä—Å–∏—è–º–∏ –≤—Å–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤.

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ Docker-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤

–î–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–æ–π —Å—Ä–µ–¥—ã —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞:

1. **–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∫—Ä–æ—Å—Å-–∫–æ–º–ø–∏–ª—è—Ü–∏–∏** ([Dockerfile.tests](https://github.com/AleksandrVin/logging_cmsis_rtos2/blob/main/test/Dockerfile.tests))
   - –°–æ–¥–µ—Ä–∂–∏—Ç ARM GCC toolchain, –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–π –Ω–∞–ø—Ä—è–º—É—é —Å developer.arm.com
   - –û–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –¥–æ—Å—Ç—É–ø –∫ –ø–æ—Å–ª–µ–¥–Ω–µ–π –≤–µ—Ä—Å–∏–∏ arm-none-eabi-gcc
   - –í–∫–ª—é—á–∞–µ—Ç make –∏ –¥—Ä—É–≥–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã —Å–±–æ—Ä–∫–∏

2. **–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å QEMU** ([Dockerfile.qemu_stm32](https://github.com/AleksandrVin/logging_cmsis_rtos2/blob/main/test/Dockerfile.qemu_stm32))
   - –°–æ–±–∏—Ä–∞–µ—Ç QEMU –∏–∑ –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –∫–æ–¥–∞ [beckus/qemu_stm32](https://github.com/beckus/qemu_stm32)
   - –ö–æ–º–ø–∏–ª—è—Ü–∏—è QEMU –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø–µ—Ä–≤–æ–π —Å–±–æ—Ä–∫–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
   - –≠–º—É–ª–∏—Ä—É–µ—Ç –ø–µ—Ä–∏—Ñ–µ—Ä–∏—é –º–∏–∫—Ä–æ–∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞

    > ‚ö†Ô∏è **–í–∞–∂–Ω–æ:** –ò—Å–ø–æ–ª—å–∑—É–µ–º–∞—è –≤–µ—Ä—Å–∏—è QEMU —è–≤–ª—è–µ—Ç—Å—è —É—Å—Ç–∞—Ä–µ–≤—à–µ–π –∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Å—Ç–∞—Ä—ã–µ –º–æ–¥–µ–ª–∏ STM32. –°—É—â–µ—Å—Ç–≤—É–µ—Ç –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç—å –≤ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —ç–º—É–ª—è—Ç–æ—Ä–∞ –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –º–∏–∫—Ä–æ–∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–æ–≤ STM32. –≠—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–º –ø—Ä–æ–µ–∫—Ç–æ–º –¥–ª—è —Å–æ–æ–±—â–µ—Å—Ç–≤–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤.

3. **–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∑–∞–ø—É—Å–∫–∞ —Ç–µ—Å—Ç–æ–≤** ([Dockerfile.run_tests](https://github.com/AleksandrVin/logging_cmsis_rtos2/blob/main/test/Dockerfile.run_tests))
   - –û–±—ä–µ–¥–∏–Ω—è–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ä–∞–±–æ—Ç—ã –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
   - –ó–∞–ø—É—Å–∫–∞–µ—Ç —Ç–µ—Å—Ç—ã –∏ —Å–æ–±–∏—Ä–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
   - –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ—Ç—á–µ—Ç—ã –æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏

### QEMU –¥–ª—è STM32

QEMU - —ç—Ç–æ –º–æ—â–Ω—ã–π —ç–º—É–ª—è—Ç–æ—Ä, —Å–ø–æ—Å–æ–±–Ω—ã–π —ç–º—É–ª–∏—Ä–æ–≤–∞—Ç—å —Ä–∞–∑–ª–∏—á–Ω—ã–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–æ–≤. –î–ª—è —Ä–∞–±–æ—Ç—ã —Å STM32 –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è QEMU —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –ø–µ—Ä–∏—Ñ–µ—Ä–∏–∏ STM32.

#### –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º–∞—è –ø–µ—Ä–∏—Ñ–µ—Ä–∏—è

–ù–∞ –º–æ–º–µ–Ω—Ç –Ω–∞–ø–∏—Å–∞–Ω–∏—è —Å—Ç–∞—Ç—å–∏ –¥–ª—è STM32F103C8 –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è:

- UART
- –¢–∞–π–º–µ—Ä—ã
- GPIO
- –ü—Ä–µ—Ä—ã–≤–∞–Ω–∏—è
- –ë–∞–∑–æ–≤—ã–µ —Å–∏—Å—Ç–µ–º–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏

> üí° **–°–æ–≤–µ—Ç:** –ù–µ—Å–º–æ—Ç—Ä—è –Ω–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–π –≤–µ—Ä—Å–∏–∏ QEMU, —ç—Ç–æ—Ç –ø–æ–¥—Ö–æ–¥ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é –º–æ–∂–µ—Ç –±—ã—Ç—å –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω –ø–æ–¥ –¥—Ä—É–≥–∏–µ —ç–º—É–ª—è—Ç–æ—Ä—ã –∏–ª–∏ –±–æ–ª–µ–µ –Ω–æ–≤—ã–µ –≤–µ—Ä—Å–∏–∏ QEMU –ø–æ –º–µ—Ä–µ –∏—Ö –ø–æ—è–≤–ª–µ–Ω–∏—è.

## –¢–µ—Å—Ç–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç

### –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–æ–µ–∫—Ç–∞ –≤ STM32CubeMX

–ü—Ä–æ–µ–∫—Ç —Å–æ–∑–¥–∞–Ω —Å –ø–æ–º–æ—â—å—é STM32CubeMX, —á—Ç–æ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é –Ω–∞—á–∞–ª—å–Ω—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –º–∏–∫—Ä–æ–∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞ –∏ –ø–µ—Ä–∏—Ñ–µ—Ä–∏–∏.

![–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Ç–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è STM32CubeMX](./stm32cubemx_clocks.png)

–ö–ª—é—á–µ–≤—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞:

- –¢–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: HSE 8 –ú–ì—Ü —Å PLL –¥–æ 72 –ú–ì—Ü
- UART1 –¥–ª—è –≤—ã–≤–æ–¥–∞ –ª–æ–≥–æ–≤
- GPIO PC13 –¥–ª—è LED-–∏–Ω–¥–∏–∫–∞—Ü–∏–∏
- –°–∏—Å—Ç–µ–º–Ω—ã–µ —Ç–∞–π–º–µ—Ä—ã –¥–ª—è FreeRTOS

![–û–∫–Ω–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ FreeRTOS](./stm32cubemx_rtos.png)
> –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è FreeRTOS —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º CMSIS-RTOS2 API

–ü—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–æ–¥–∞ –≤–∞–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:

![–û–∫–Ω–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞](./stm32cubemx_additional_code_gen.png)
> –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –±–∏–±–ª–∏–æ—Ç–µ–∫ –≤ –ø—Ä–æ–µ–∫—Ç. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ .c –∏ .h —Ñ–∞–π–ª–æ–≤ –¥–ª—è –ø–µ—Ä–∏—Ñ–µ—Ä–∏–∏.

![–û–∫–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–æ–¥–∞](./stm32cubemx_project_gen.png)
> –í—ã–±–æ—Ä Makefile –≤ –∫–∞—á–µ—Å—Ç–≤–µ —Å–∏—Å—Ç–µ–º—ã —Å–±–æ—Ä–∫–∏ –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å Docker. –£–≤–µ–ª–∏—á–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ –∫—É—á–∏, —Ç–∞–∫ –∫–∞–∫ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –ø–∞–º—è—Ç—å –≤–æ FreeRTOS. –ü—Ä–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ —Å–æ–∑–¥–∞–µ—Ç—Å—è 10 –ø–æ—Ç–æ–∫–æ–≤.

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

–ü—Ä–æ–µ–∫—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É STM32CubeMX, –∫–æ—Ç–æ—Ä–∞—è –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ `tests_stm32`. –°–∫—Ä–∏–ø—Ç—ã –¥–ª—è —Å–±–æ—Ä–∫–∏ –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ `test`. –¢–µ—Å—Ç–∏—Ä—É–µ–º–∞—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ `lib` –∏ –∫–æ–ø–∏—Ä—É–µ—Ç—Å—è –≤ –ø—Ä–æ–µ–∫—Ç –ø—Ä–∏ —Å–±–æ—Ä–∫–µ.

```tree
‚îú‚îÄ‚îÄ lib
‚îÇ   ‚îú‚îÄ‚îÄ logging.c
‚îÇ   ‚îú‚îÄ‚îÄ logging.h
‚îÇ   ‚îú‚îÄ‚îÄ logging_usb.c
‚îÇ   ‚îî‚îÄ‚îÄ logging_usb.h
‚îú‚îÄ‚îÄ LICENSE
‚îú‚îÄ‚îÄ README.md
‚îî‚îÄ‚îÄ test
    ‚îú‚îÄ‚îÄ compose.yaml
    ‚îú‚îÄ‚îÄ Dockerfile.qemu_stm32
    ‚îú‚îÄ‚îÄ Dockerfile.run_tests
    ‚îú‚îÄ‚îÄ Dockerfile.tests
    ‚îú‚îÄ‚îÄ start_qemu_gdb_mode.sh
    ‚îú‚îÄ‚îÄ test_in_docker.sh
    ‚îú‚îÄ‚îÄ test.sh
    ‚îú‚îÄ‚îÄ tests_stm32
    ‚îÇ   ‚îú‚îÄ‚îÄ Core
    ‚îÇ   ‚îú‚îÄ‚îÄ Drivers
    ‚îÇ   ‚îú‚îÄ‚îÄ logging_cmsis_rtos2
    ‚îÇ   ‚îú‚îÄ‚îÄ Makefile
    ‚îÇ   ‚îú‚îÄ‚îÄ Middlewares
    ‚îÇ   ‚îú‚îÄ‚îÄ startup_stm32f103xb.s
    ‚îÇ   ‚îú‚îÄ‚îÄ STM32F103C8Tx_FLASH.ld
    ‚îÇ   ‚îî‚îÄ‚îÄ tests_stm32.ioc
    ‚îî‚îÄ‚îÄ verify_output.py
```

–ü—Ä–∏ —Å–±–æ—Ä–∫–µ, `test.sh` –∫–æ–ø–∏—Ä—É–µ—Ç –±–∏–±–ª–∏–æ—Ç–µ–∫—É –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –≤ —Ç–µ—Å—Ç–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç –∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç —Å–±–æ—Ä–∫—É. –í `Makefile` –¥–æ–±–∞–≤–ª–µ–Ω—ã –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ–ª–∞–≥–∏ –¥–ª—è —Å–±–æ—Ä–∫–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –∏ —Ç–µ—Å—Ç–æ–≤.

### FreeRTOS –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è

FreeRTOS –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ STM32CubeMX —Å–æ —Å–ª–µ–¥—É—é—â–∏–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏:

- –í–∫–ª—é—á–µ–Ω DefaultTask
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –≤—ã–¥–µ–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏
- –£–≤–µ–ª–∏—á–µ–Ω —Ä–∞–∑–º–µ—Ä heap –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –º–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–æ–≥–æ —Ç–µ—Å—Ç–∞, –≤ –∫–æ—Ç–æ—Ä–æ–º —Å–æ–∑–¥–∞–µ—Ç—Å—è 10 –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –ø–æ—Ç–æ–∫–æ–≤. –ü—Ä–∏ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ FreeRTOS —Ö–≤–∞—Ç–∞–µ—Ç –ø–∞–º—è—Ç–∏ —Ç–æ–ª—å–∫–æ –Ω–∞ —Å–æ–∑–¥–∞–Ω–∏–µ 2 –ø–æ—Ç–æ–∫–æ–≤
- –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω—ã —Ñ—É–Ω–∫—Ü–∏–∏ —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∏ (–ø–æ–¥—Ä–æ–±–Ω–µ–µ –≤ —Ä–∞–∑–¥–µ–ª–µ –æ—Ç–ª–∞–¥–∫–∏)

–í–µ—Å—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –∫–æ–¥ FreeRTOS —Ä–∞–∑–º–µ—â–∞–µ—Ç—Å—è –≤ `freertos.c`:

```c:test/tests_stm32/Core/Src/freertos.c
// –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø–æ—Ç–æ–∫–∞
osThreadId_t defaultTaskHandle;
const osThreadAttr_t defaultTask_attributes = {
  .name = "defaultTask",
  .stack_size = 128 * 4,
  .priority = (osPriority_t) osPriorityNormal,
};

// –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –¥–ª—è —Ç–µ—Å—Ç–æ–≤
void StartDefaultTask(void *argument)
{
  logging_init();
  // –ó–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è —Ç–µ—Ä–º–∏–Ω–∞–ª–∞
  osDelay(1000);
  // –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤
  logging_test();
  // ...
}
```

–≠—Ç–æ—Ç –ø–æ—Ç–æ–∫ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞–∫ —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –¥–ª—è –∑–∞–ø—É—Å–∫–∞ —Ç–µ—Å—Ç–æ–≤ –∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è.

> üí° **–°–æ–≤–µ—Ç:** STM32CubeMX –ø–æ–∑–≤–æ–ª—è–µ—Ç –ª–µ–≥–∫–æ –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –ø—Ä–æ–µ–∫—Ç–∞ —á–µ—Ä–µ–∑ –≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Å –ø–æ—Å–ª–µ–¥—É—é—â–µ–π —Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏–µ–π –∫–æ–¥–∞. –û–¥–Ω–∞–∫–æ, —ç—Ç–æ –∏ –≤ –Ω–µ–∫–æ—Ç–æ—Ä–æ–º —Å–º—ã—Å–ª–µ –æ–±—è–∑–∞–≤–∞–µ—Ç —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞ –≤—Å–µ–≥–¥–∞ –∏–∑–º–µ–Ω—è—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é —á–µ—Ä–µ–∑ cubemx, –¥–∞–±—ã –Ω–µ –Ω–∞—Ä—É—à–∏—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø—Ä–æ–µ–∫—Ç–∞, —á—Ç–æ —Å–∫–∞–∂–µ—Ç—Å—è –Ω–∞ —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏ –∫–æ–¥–∞ –∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—è—Ö –¥–æ—Ä–∞–±–æ—Ç–∫–∏.

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è

–¢–µ—Å—Ç—ã —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã –≤ [`tests.c`](https://github.com/AleksandrVin/logging_cmsis_rtos2/blob/main/test/tests_stm32/Core/Src/tests.c) –∏ –ø—Ä–æ–≤–µ—Ä—è—é—Ç —Ä–∞–∑–ª–∏—á–Ω—ã–µ —Ä–µ–∂–∏–º—ã —Ä–∞–±–æ—Ç—ã –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è:

```c:test/tests_stm32/Core/Src/tests.c
void logging_test()
{
    logging_basic_test("basic_test");                  // –ë–∞–∑–æ–≤—ã–µ —Ç–µ—Å—Ç—ã
    osDelay(200);                                      // –û–∂–∏–¥–∞–Ω–∏–µ –≤—ã–≤–æ–¥–∞ –ª–æ–≥–æ–≤
    logging_test_pack("pack_of_ten_ten_times");       // –ü–∞–∫–µ—Ç–Ω–∞—è –∑–∞–ø–∏—Å—å
    osDelay(200);                                      // –û–∂–∏–¥–∞–Ω–∏–µ –≤—ã–≤–æ–¥–∞ –ª–æ–≥–æ–≤
    logging_test_different_levels("different_levels"); // –†–∞–∑–Ω—ã–µ —É—Ä–æ–≤–Ω–∏ –ª–æ–≥–æ–≤
    osDelay(200);                                      // –û–∂–∏–¥–∞–Ω–∏–µ –≤—ã–≤–æ–¥–∞ –ª–æ–≥–æ–≤
    logging_test_fatal("fatal");                      // –§–∞—Ç–∞–ª—å–Ω—ã–µ –æ—à–∏–±–∫–∏
    osDelay(200);                                      // –û–∂–∏–¥–∞–Ω–∏–µ –≤—ã–≤–æ–¥–∞ –ª–æ–≥–æ–≤
    logging_interrupt();                              // –õ–æ–≥–∏ –∏–∑ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–π
    osDelay(200);                                      // –û–∂–∏–¥–∞–Ω–∏–µ –≤—ã–≤–æ–¥–∞ –ª–æ–≥–æ–≤
    logging_test_multiple_threads();                  // –ú–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω—ã–π —Ç–µ—Å—Ç
}
```

> üí° **–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –ó–∞–¥–µ—Ä–∂–∫–∏ –º–µ–∂–¥—É —Ç–µ—Å—Ç–∞–º–∏ (`osDelay`) –ø–æ–∑–≤–æ–ª—è—é—Ç –ø–æ—Ç–æ–∫—É –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –æ–ø—É—Å—Ç–æ—à–∏—Ç—å –±—É—Ñ–µ—Ä—ã –∏ —á–µ—Ç–∫–æ —Ä–∞–∑–¥–µ–ª–∏—Ç—å –≤—ã–≤–æ–¥ —Ä–∞–∑–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤.

### –ö–ª—é—á–µ–≤—ã–µ —Ç–µ—Å—Ç–æ–≤—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏

1. **–ë–∞–∑–æ–≤–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**

    ```text
    [INFO     ][1s.1]: basic_test_0
    [INFO     ][1s.12]: basic_test_1
    [INFO     ][1s.22]: basic_test_2
    ```

    - –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π
    - –í—Ä–µ–º–µ–Ω–Ω—ã–µ –º–µ—Ç–∫–∏ —Å –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–Ω–æ–π —Ç–æ—á–Ω–æ—Å—Ç—å—é
    - –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–∞—è –∑–∞–ø–∏—Å—å –ª–æ–≥–æ–≤

    –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç–∏–∫–∏ —è–¥—Ä–∞ FreeRTOS –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏. –í—Ä–µ–º—è —Ñ–∏–∫—Å–∏—Ä–∏—É–µ—Ç—Å—è –ø—Ä–∏ –≤—ã–∑–æ–≤–µ —Ñ—É–Ω–∫—Ü–∏–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –∏ —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ –±—É—Ñ–µ—Ä–µ –¥–æ –ø–µ—Ä–µ–¥–∞—á–∏ —á–µ—Ä–µ–∑ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å, —Ç–µ –æ—Ç—Ä–∞–∂–∞–µ—Ç –≤—Ä–µ–º—è –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏—è —Å–æ–±—ã—Ç–∏—è, –∞ –Ω–µ –ø–µ—Ä–µ–¥–∞—á–∏ —á–µ—Ä–µ–∑ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å.

2. **–£—Ä–æ–≤–Ω–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è**

    ```text
    [DEBUG_ALL][2s.112]: different_levels_DEBUG_ALL
    [DEBUG_MIN][2s.112]: different_levels_DEBUG_MIN
    [INFO     ][2s.112]: different_levels_INFO
    [WARNING  ][2s.112]: different_levels_WARNING
    [ERROR    ][2s.112]: different_levels_ERR
    ```

3. **–°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Ä–µ–∂–∏–º—ã**

    ```text
    # –§–∞—Ç–∞–ª—å–Ω—ã–µ –æ—à–∏–±–∫–∏ (–ø—Ä—è–º–æ–π –≤—ã–≤–æ–¥ –≤ UART)
    fatal_0
    fatal_1

    # –õ–æ–≥–∏ –∏–∑ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–π (–±–µ–∑ –±—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏–∏)
    [INFO     ][2s.512]ISR: LOG_ISR_9
    ```

    - `LOG_FATAL` - –ø—Ä—è–º–∞—è –∑–∞–ø–∏—Å—å –≤ UART, –±–µ–∑ –±—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏–∏
    - `LOG_ISR` - –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–∑ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–π, –±–µ–∑ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –±—É—Ñ–µ—Ä–∞

    ```c:test/tests_stm32/Core/Src/tests.c
    void logging_interrupt()
    {
        // —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–π –ª–æ–≥ –±—É–¥–µ—Ç –Ω–∞–ø–µ—á–∞—Ç–∞–Ω
        for (int i = 0; i < LOGS_AT_ONCE; i++) {
            LOG_ISR(INFO, "LOG_ISR_%d", i);
        }
    }
    ```

    > ‚ö†Ô∏è **–í–∞–∂–Ω–æ –ø—Ä–æ ISR:** –í –≤—ã–≤–æ–¥–µ –≤–∏–¥–Ω–æ —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (`LOG_ISR_9`), –∏ —ç—Ç–æ –æ–∂–∏–¥–∞–µ–º–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ. –í –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è:
    > - –ù–µ–ª—å–∑—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–ª–æ–∫–∏—Ä—É—é—â–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
    > - –ë—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏—è –Ω–µ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è
    > - –ü–æ—Ç–æ–∫ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –∏–º–µ–µ—Ç –±–æ–ª–µ–µ –Ω–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç
    > –í —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ, –ø–æ–∫–∞ –ø–æ—Ç–æ–∫ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ–¥–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ, —Å–ª–µ–¥—É—é—â–∏–π –≤—ã–∑–æ–≤ `LOG_ISR` —É–∂–µ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ. –≠—Ç–æ –∫–æ–º–ø—Ä–æ–º–∏—Å—Å –º–µ–∂–¥—É –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å—é —Ä–∞–±–æ—Ç—ã –≤ ISR –∏ –≥–∞—Ä–∞–Ω—Ç–∏–µ–π –¥–æ—Å—Ç–∞–≤–∫–∏ –≤—Å–µ—Ö —Å–æ–æ–±—â–µ–Ω–∏–π.

4. **–ú–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω—ã–π —Ç–µ—Å—Ç**

    ```c
    void logging_test_multiple_threads()
    {
        for (int i = 0; i < THREADS_AMOUNT; i++) {
            threads[i] = osThreadNew(logging_thread, names[i], NULL);
        }
    }
    ```

    ```text
    [INFO     ][2s.812]: logging_thread_4_0
    [INFO     ][2s.812]: logging_thread_4_1
    [INFO     ][2s.812]: logging_thread_5_1
    [INFO     ][2s.812]: logging_thread_6_1
    ```

    - 10 –ø–æ—Ç–æ–∫–æ–≤ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –ø–∏—à—É—Ç –ª–æ–≥–∏
    - –¢–µ—Å—Ç–∏—Ä—É–µ—Ç —Ü–∏–∫–ª–∏—á–µ—Å–∫–∏–π –±—É—Ñ–µ—Ä –ø–æ–¥ –Ω–∞–≥—Ä—É–∑–∫–æ–π
    - –ü–æ—Ç–æ–∫ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –∏–º–µ–µ—Ç –Ω–æ—Ä–º–∞–ª—å–Ω—ã–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç
    - –¢–µ—Å—Ç–æ–≤—ã–µ –ø–æ—Ç–æ–∫–∏ –±–ª–æ–∫–∏—Ä—É—é—Ç—Å—è –ø—Ä–∏ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–∏ –±—É—Ñ–µ—Ä–∞

    > üí° **–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç—å:** –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –æ—Ç–ª–æ–∂–µ–Ω–Ω—ã–π –≤—ã–≤–æ–¥ –ª–æ–≥–æ–≤ —á–µ—Ä–µ–∑ UART. –ü—Ä–∏ –º–∞–ª–æ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ –ª–æ–≥–æ–≤ –æ–Ω–∏ –≤—ã–≤–æ–¥—è—Ç—Å—è –≤ —Ñ–æ–Ω–æ–≤–æ–º —Ä–µ–∂–∏–º–µ. –ü—Ä–∏ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏–∏ –±—É—Ñ–µ—Ä–∞ –ø–æ—Ç–æ–∫–∏ –±–ª–æ–∫–∏—Ä—É—é—Ç—Å—è –¥–æ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏—è –º–µ—Å—Ç–∞. –†–µ–∂–∏–º—ã `LOG_FATAL` –∏ `LOG_ISR` –æ–±–µ—Å–ø–µ—á–∏–≤–∞—é—Ç –º–≥–Ω–æ–≤–µ–Ω–Ω—ã–π –≤—ã–≤–æ–¥.

### –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –≤—ã–≤–æ–¥–∞

–ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è —Å–∫—Ä–∏–ø—Ç–æ–º [`verify_output.py`](https://github.com/AleksandrVin/logging_cmsis_rtos2/blob/main/test/verify_output.py). QEMU —Å–æ–∑–¥–∞–µ—Ç –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π —Ç–µ—Ä–º–∏–Ω–∞–ª, –≤ –∫–æ—Ç–æ—Ä—ã–π —ç–º—É–ª–∏—Ä—É–µ–º–∞—è STM32 –≤—ã–≤–æ–¥–∏—Ç –¥–∞–Ω–Ω—ã–µ. –°–∫—Ä–∏–ø—Ç –Ω–∞ Python –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ —ç—Ç–æ–º—É —Ç–µ—Ä–º–∏–Ω–∞–ª—É –∏ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –≤—ã–≤–æ–¥–∞.

```python
# –ü—Ä–∏–º–µ—Ä –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ñ–æ—Ä–º–∞—Ç–∞ INFO —Å–æ–æ–±—â–µ–Ω–∏—è
pattern = r"\[INFO\s*\]\[(\d+)s\.(\d+)\]: basic_test_(\d+)"
match = re.match(pattern, output)
if match:
    seconds = int(match.group(1))
    milliseconds = int(match.group(2))
    test_number = int(match.group(3))
```

–°–∫—Ä–∏–ø—Ç –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è —É—Å–ø–µ—à–Ω–æ, –µ—Å–ª–∏ –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã. –î–∞–Ω–Ω—ã–π —É—á–∞—Å—Ç–æ–∫ –∫–æ–¥–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–æ—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π —Ç–µ—Å—Ç–∏—Ä—É–µ–º–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞. –ù–∞–ø—Ä–∏–º–µ—Ä, –≤ —Å–ª—É—á–∞–µ –∑–∞–≤–∏—Å–∞–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞ –∏–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è –ø–æ–ª–Ω–æ–≥–æ –Ω–∞–±–æ—Ä–∞ —Å–æ–æ–±—â–µ–Ω–∏–π, —Å–∫—Ä–∏–ø—Ç –±—É–¥–µ—Ç –æ–∂–∏–¥–∞—Ç—å –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ. –≠—Ç–æ –º–æ–∂–Ω–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å, –¥–æ–±–∞–≤–∏–≤ —Ç–∞–π–º–∞—É—Ç—ã –∏ –±–æ–ª–µ–µ —Å–ª–æ–∂–Ω—É—é –ª–æ–≥–∏–∫—É, –∫–æ—Ç–æ—Ä–∞—è –ø—Ä–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–∏ —Ç–∞–∫–∏—Ö —Å–∏—Ç—É–∞—Ü–∏–π –±—É–¥–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –º–µ—Ö–∞–Ω–∏–∑–º "–≤—ã–∫–ª—é—á–µ–Ω–∏—è" QEMU, –Ω–∞–ø—Ä–∏–º–µ—Ä, –ø—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ HardFault –∏–ª–∏ –∞–Ω–∞–ª–æ–≥–∏—á–Ω—ã—Ö –æ—à–∏–±–æ–∫.

## –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–ü–æ—Å–ª–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —Ç–µ—Å—Ç–æ–≤—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ —Å–ª–µ–¥—É—é—â–∏–º —à–∞–≥–æ–º —è–≤–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –∏—Ö –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è. –î–ª—è —ç—Ç–æ–≥–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–æ–º–±–∏–Ω–∞—Ü–∏—è Docker –∏ GitHub Actions.

### Docker-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏–∑–∞—Ü–∏—è

–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤ —Ç–µ—Ö –∂–µ —Ç—Ä–µ—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞—Ö, –æ–ø–∏—Å–∞–Ω–Ω—ã—Ö —Ä–∞–Ω–µ–µ:

```yaml
services:
  tests:
    build:
      context: .
      dockerfile: Dockerfile.tests
    image: tests
  
  qemu_stm32:
    build:
      context: .
      dockerfile: Dockerfile.qemu_stm32
    depends_on:
      - tests
    image: qemu_stm32

  run_tests: &run_tests
    build:
      context: .
      dockerfile: Dockerfile.run_tests
    depends_on:
      - qemu_stm32
      - tests
    volumes:
      - ./logs/:/test/logs
      - ./elf/:/elf
    profiles:
      - test
    image: run_tests
```

–ö–∞–∂–¥—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –≤—ã–ø–æ–ª–Ω—è–µ—Ç —Å–≤–æ—é —Ä–æ–ª—å –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:

1. `tests` ‚Äî –∫–æ–º–ø–∏–ª–∏—Ä—É–µ—Ç –ø—Ä–æ—à–∏–≤–∫—É —Å —Ç–µ—Å—Ç–∞–º–∏.
2. `qemu_stm32` ‚Äî –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç —Å—Ä–µ–¥—É —ç–º—É–ª—è—Ü–∏–∏.
3. `run_tests` ‚Äî –∑–∞–ø—É—Å–∫–∞–µ—Ç —Ç–µ—Å—Ç—ã –∏ –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä—É–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã.

### –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤

–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –∑–∞–ø—É—Å–∫–∞ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ —á–µ—Ä–µ–∑ —Å–∫—Ä–∏–ø—Ç `test.sh`:

```shell
#!/bin/bash
# –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –≤ —Ç–µ—Å—Ç–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç
cp -r ../lib/ tests_stm32/logging_cmsis_rtos2

# –ó–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
docker compose --profile test up --build

# –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ª–æ–≥–æ–≤
docker compose logs $container > $logs_file

# –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–¥–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
exit_code=$(docker inspect -f '{{.State.ExitCode}}' $test_container_name)
```

> üí° **–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç—å:** –°–∫—Ä–∏–ø—Ç –Ω–µ —Ç–æ–ª—å–∫–æ –∑–∞–ø—É—Å–∫–∞–µ—Ç —Ç–µ—Å—Ç—ã, –Ω–æ –∏ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.

#### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å CI/CD

–¢–µ—Å—Ç—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è –ø—Ä–∏ –∫–∞–∂–¥–æ–º push –∏ pull request —á–µ—Ä–µ–∑ GitHub Actions:

```yaml:.github/workflows/test.yml
name: CI
on: 
    push:
    pull_request:

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Run test
      run: cd test && ./test.sh
    - name: Archive test results
      uses: actions/upload-artifact@v4
      with:
        name: combined_logs
        path: |
          ./test/logs/logs.txt
          ./test/logs/serial_output.txt
```

> üí° **–°–æ–≤–µ—Ç:** –î–ª—è –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –º–æ–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å self-hosted runner –Ω–∞ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–º —Å–µ—Ä–≤–µ—Ä–µ —Å–±–æ—Ä–∫–∏. –ü–æ–¥—Ö–æ–¥ —Å–æ–≤–º–µ—Å—Ç–∏–º —Å GitLab CI –∏ –¥—Ä—É–≥–∏–º–∏ CI-—Å–∏—Å—Ç–µ–º–∞–º–∏. –í –¥–∞–Ω–Ω–æ–º —Å–ª—É—á–∞–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è GitHub Actions, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è –±–µ—Å–ø–ª–∞—Ç–Ω–æ –¥–ª—è open-source –ø—Ä–æ–µ–∫—Ç–æ–≤.

### –ê–Ω–∞–ª–∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

–¢–µ—Å—Ç—ã –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç –¥–≤–∞ —Ñ–∞–π–ª–∞ —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏:

1. `logs.txt` ‚Äî –æ—Ç–ª–∞–¥–æ—á–Ω—ã–π –≤—ã–≤–æ–¥ –ø—Ä–æ—Ü–µ—Å—Å–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
2. `serial_output.txt` ‚Äî –ª–æ–≥–∏ –æ—Ç —Ç–µ—Å—Ç–∏—Ä—É–µ–º–æ–π –±–∏–±–ª–∏–æ—Ç–µ–∫–∏

–≠—Ç–∏ —Ñ–∞–π–ª—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –∫–∞–∫ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã —Å–±–æ—Ä–∫–∏ –∏ –º–æ–≥—É—Ç –±—ã—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω—ã –¥–ª—è:

- –ê–Ω–∞–ª–∏–∑–∞ –ø—Ä–∏—á–∏–Ω –Ω–µ—É–¥–∞—á —Ç–µ—Å—Ç–æ–≤
- –ü—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏ —Ä–∞–±–æ—Ç—ã –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
- –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–≤–µ–¥–µ–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã

## –û—Ç–ª–∞–¥–∫–∞ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º GDB –∏ QEMU

–û—Ç–ª–∞–¥–∫–∞ –≤—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã—Ö —Å–∏—Å—Ç–µ–º —á–∞—Å—Ç–æ –Ω–∞–ø–æ–º–∏–Ω–∞–µ—Ç –¥–µ—Ç–µ–∫—Ç–∏–≤–Ω–æ–µ —Ä–∞—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ. –ö —Å—á–∞—Å—Ç—å—é, QEMU –∏ GDB –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è—é—Ç –ø–æ–ª–Ω—ã–π –Ω–∞–±–æ—Ä –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –¥–ª—è —ç—Ç–æ–≥–æ.

### –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç?

QEMU, –∫–∞–∫ –∏—Å—Ç–∏–Ω–Ω—ã–π –ø—Ä–æ–µ–∫—Ç GNU, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤—Å–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –æ—Ç–ª–∞–¥–∫–∏. –î–ª—è —Ç–µ—Å—Ç–æ–≤ –º—ã –ø—Ä–æ—Å—Ç–æ —É–∫–∞–∑—ã–≤–∞–µ–º –∏–º—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ–≥–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞:

```shell:test/test_in_docker.sh
QEMU_FLAGS=(
    "-nographic"
    "-M" "stm32-f103c8"
    "-kernel" "/app/firmware.bin"
    "-serial" "pty"
)
```

> üí° **–î–ª—è –ª—é–±–æ–ø—ã—Ç–Ω—ã—Ö:** –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –º–µ–∂–¥—É USART'–∞–º–∏ STM32 –∏ PTY –≤ QEMU –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –≤ –∏—Å—Ö–æ–¥–Ω–æ–º –∫–æ–¥–µ —ç–º—É–ª—è—Ç–æ—Ä–∞. –ï—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è —á—Ç–æ-—Ç–æ –æ—Å–æ–±–µ–Ω–Ω–æ–µ, –ø—Ä–∏–¥–µ—Ç—Å—è –∏–∑—É—á–∞—Ç—å –∏—Å—Ö–æ–¥–Ω–∏–∫–∏. RTSL ‚Äî Read The Source, Luke!

### –†–µ–∂–∏–º –æ—Ç–ª–∞–¥–∫–∏

–°–∫—Ä–∏–ø—Ç `test_in_docker.sh` –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –¥–≤–∞ —Ä–µ–∂–∏–º–∞ —Ä–∞–±–æ—Ç—ã:

1. **–¢–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º** ‚Äî –æ–±—ã—á–Ω—ã–π –∑–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤
2. **–†–µ–∂–∏–º –æ—Ç–ª–∞–¥–∫–∏** ‚Äî –∑–∞–ø—É—Å–∫ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π GDB:

```shell:test/test_in_docker.sh
if [ "$1" == "gdb" ]; then
    QEMU_FLAGS+=(
        "-gdb" "tcp::3333"  # GDB-—Å–µ—Ä–≤–µ—Ä –Ω–∞ –ø–æ—Ä—Ç—É 3333
        "-S"                # –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
    )
    echo "Starting QEMU in GDB debug mode..."
fi
```

### –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –æ—Ç–ª–∞–¥—á–∏–∫–∞

–î–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ QEMU –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `arm-none-eabi-gdb`. –í —Ç–µ—Å—Ç–æ–≤–æ–º –ø—Ä–æ–µ–∫—Ç–µ –µ—Å—Ç—å –≥–æ—Ç–æ–≤–∞—è —Ü–µ–ª—å:

```makefile:tests_stm32/Makefile
gdb: 
    arm-none-eabi-gdb ../elf/firmware.elf -ex "target extended-remote :3333"
```

> ‚ö†Ô∏è **–í–∞–∂–Ω–æ:** –ó–¥–µ—Å—å –µ—Å—Ç—å –Ω–µ–±–æ–ª—å—à–∞—è –º–∞–≥–∏—è! –ü—Ä–æ—à–∏–≤–∫–∞ –¥–ª—è GDB –±–µ—Ä–µ—Ç—Å—è –∏–∑ Docker-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ —á–µ—Ä–µ–∑ volume:
>
> ```yaml:test/compose.yaml
> volumes:
>   - ./elf/:/elf    # –§–∞–π–ª—ã –¥–ª—è GDB
> ```

### –ó–∞–ø—É—Å–∫ –æ—Ç–ª–∞–¥–∫–∏ (GDB)

–î–ª—è –∑–∞–ø—É—Å–∫–∞ QEMU –≤ —Ä–µ–∂–∏–º–µ –æ—Ç–ª–∞–¥–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π —Å–∫—Ä–∏–ø—Ç:

```shell:test/start_qemu_gdb_mode.sh
#!/bin/bash
docker compose --profile gdb up --build
```

–û–Ω –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø—Ä–æ—Ñ–∏–ª—å `gdb` –≤ Docker Compose:

```yaml:test/compose.yaml
gdb:
  <<: *run_tests           # –ù–∞—Å–ª–µ–¥—É–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –æ—Ç run_tests
  ports:
    - "3333:3333"         # –û—Ç–∫—Ä—ã–≤–∞–µ–º –ø–æ—Ä—Ç –¥–ª—è GDB
  profiles:
    - gdb                 # –û—Ç–¥–µ–ª—å–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å
  entrypoint: ["./test_in_docker.sh", "gdb"]
```

> üí° **–ü—Ä–æ—Ñ–∏–ª–∏ –≤ Docker Compose** –ø–æ–∑–≤–æ–ª—è—é—Ç –∏–º–µ—Ç—å —Ä–∞–∑–ª–∏—á–Ω—ã–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –≤ –æ–¥–Ω–æ–º —Ñ–∞–π–ª–µ. –ü—Ä–æ—Ñ–∏–ª—å `test` –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω –¥–ª—è —Ç–µ—Å—Ç–æ–≤, –∞ `gdb` ‚Äî –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏. –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –≤—ã–±–∏—Ä–∞—Ç—å, –∫–∞–∫—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –∑–∞–ø—É—Å–∫–∞—Ç—å –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–µ–∫—É—â–∏—Ö –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–µ–π.

#### –ü—Ä–æ—Ü–µ—Å—Å –æ—Ç–ª–∞–¥–∫–∏

1. **–ó–∞–ø—É—Å–∫ QEMU –≤ —Ä–µ–∂–∏–º–µ –æ—Ç–ª–∞–¥–∫–∏:**

   ```bash
   ./start_qemu_gdb_mode.sh
   ```

2. **–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ GDB –≤ –¥—Ä—É–≥–æ–º —Ç–µ—Ä–º–∏–Ω–∞–ª–µ:**

   ```bash
   cd tests_stm32 && make gdb
   ```

3. **–û–∂–∏–¥–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è GDB:**
   QEMU –æ–∂–∏–¥–∞–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∏ —É–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –ø—Ä–æ—à–∏–≤–∫—É –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –ø–∞—É–∑—ã, —á—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç:
   - –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å —Ç–æ—á–∫–∏ –æ—Å—Ç–∞–Ω–æ–≤–∞
   - –ò–∑—É—á–∞—Ç—å –Ω–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã
   - –û—Ç–ª–∞–∂–∏–≤–∞—Ç—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é —Å–∏—Å—Ç–µ–º—ã

#### –ü—Ä–∞–∫—Ç–∏–∫–∞ —Ä–∞–±–æ—Ç—ã —Å GDB

–ü–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞ –æ—Ç–ª–∞–¥–∫–∏ –≤—ã —É–≤–∏–¥–∏—Ç–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ç–µ—Ä–º–∏–Ω–∞–ª–æ–≤:

1. **–¢–µ—Ä–º–∏–Ω–∞–ª QEMU:**
   –í —Ç–µ—Ä–º–∏–Ω–∞–ª–µ, –≥–¥–µ –±—ã–ª –∑–∞–ø—É—â–µ–Ω —Å–∫—Ä–∏–ø—Ç `start_qemu_gdb_mode.sh`, –±—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ —Ç–æ–º, —á—Ç–æ QEMU –æ–∂–∏–¥–∞–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:

   ![QEMU terminal waiting for GDB connection](./qemu_in_docker.png)

2. **–¢–µ—Ä–º–∏–Ω–∞–ª GDB:**

   ```sh
   test/tests_stm32$ make gdb
   arm-none-eabi-gdb ../elf/firmware.elf -ex "target extended-remote :3333"
   GNU gdb (Arm GNU Toolchain 12.2.MPACBTI-Rel1 (Build arm-12-mpacbti.34)) 13.1.90.20230307-git
   Copyright (C) 2023 Free Software Foundation, Inc.
   License GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html>
   This is free software: you are free to change and redistribute it.
   There is NO WARRANTY, to the extent permitted by law.
   Type "show copying" and "show warranty" for details.
   This GDB was configured as "--host=x86_64-pc-linux-gnu --target=arm-none-eabi".
   Type "show configuration" for configuration details.
   For bug reporting instructions, please see:
   <https://bugs.linaro.org/>.
   --Type <RET> for more, q to quit, c to continue without paging--
   ```

3. **GDB –≤ —Ä–µ–∂–∏–º–µ TUI (Text User Interface):**

   –í–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ–∂–∏–º–∞ TUI –ø–æ–∑–≤–æ–ª—è–µ—Ç –≤–∏–∑—É–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ü–µ—Å—Å –æ—Ç–ª–∞–¥–∫–∏:

   ```bash
   # –í–∫–ª—é—á–∏—Ç—å TUI —Ä–µ–∂–∏–º
   (gdb) tui enable
   ```

   ![GDB in TUI mode](./tui_enable.png)

#### –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã –æ—Ç–ª–∞–¥–∫–∏

1. **–£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–æ—á–∫–∏ –æ—Å—Ç–∞–Ω–æ–≤–∞:**

   –ü–æ—Å—Ç–∞–≤–∏–º –±—Ä–µ–π–∫–ø–æ–∏–Ω—Ç –≤ —Ñ—É–Ω–∫—Ü–∏—é, –∑–∞–ø—É—Å–∫–∞—é—â—É—é —Ç–µ—Å—Ç—ã:

   ```gdb
   (gdb) break logging_test
   ```

2. **–ó–∞–ø—É—Å–∫ –ø—Ä–æ–≥—Ä–∞–º–º—ã:**

   –†–∞–∑—Ä–µ—à–∏–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã. –ò—Å–ø–æ–ª–Ω–µ–Ω–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –ø—Ä–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω–æ–≥–æ –±—Ä–µ–π–∫–ø–æ–∏–Ω—Ç–∞:

   ```gdb
   (gdb) continue
   ```
  
   ![Running program until breakpoint](./b_logging_test_c.png)

3. **–ü–æ—à–∞–≥–æ–≤–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ:**
  
   –ü–æ–∑–≤–æ–ª—è–µ—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º—É –ø–æ—Å—Ç—Ä–æ—á–Ω–æ –∏–ª–∏ –∑–∞—Ö–æ–¥–∏—Ç—å –≤–Ω—É—Ç—Ä—å —Ñ—É–Ω–∫—Ü–∏–π:
  
   ```gdb
   (gdb) next    # –í—ã–ø–æ–ª–Ω–∏—Ç—å —Å—Ç—Ä–æ–∫—É (n)
   (gdb) step    # –ó–∞–π—Ç–∏ –≤–Ω—É—Ç—Ä—å —Ñ—É–Ω–∫—Ü–∏–∏ (s)
   ```

4. **–ü—Ä–æ—Å–º–æ—Ç—Ä –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö:**
  
   –î–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∑–Ω–∞—á–µ–Ω–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ:
  
   ```gdb
   (gdb) print name     # –í—ã–≤–µ—Å—Ç–∏ –∑–Ω–∞—á–µ–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π
   (gdb) info locals    # –í—ã–≤–µ—Å—Ç–∏ –≤—Å–µ –ª–æ–∫–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
   ```
  
   ![GDB print variables](./gdb_cli_print_vars.png)
  
   > üí° **–°–æ–≤–µ—Ç:** GDB –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Å–æ–∫—Ä–∞—â–µ–Ω–∏—è –¥–ª—è —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –∫–æ–º–∞–Ω–¥:
   > - `c` = continue
   > - `n` = next
   > - `s` = step
   > - `p` = print
   > - `bt` = backtrace (—Å—Ç–µ–∫ –≤—ã–∑–æ–≤–æ–≤)

### –¢–∏–ø–∏—á–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

1. **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∫–æ–º–ø–∏–ª—è—Ç–æ—Ä–∞** –º–æ–∂–µ—Ç "—Å–ø—Ä—è—Ç–∞—Ç—å" –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ:

   ```gdb
   (gdb) print i
   No symbol "i" in current context.
   ```
  
   **–†–µ—à–µ–Ω–∏–µ:** –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ–ª–∞–≥–∏ `-O0` –≤–º–µ—Å—Ç–µ —Å `-g` (–æ—Ç–ª–∞–¥–æ—á–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã) –ø—Ä–∏ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏. –í Makefile —ç—Ç–∏ –æ–ø—Ü–∏–∏ —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã.

2. **–ü–æ—Ç–µ—Ä—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –ø—Ä–∏ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è—Ö:**
  
   ```gdb
   (gdb) where
   #0 HardFault_Handler () at ../Core/Src/stm32f1xx_it.c:89
   #1 <signal handler called>
   #2 ?? () at ??:?
   ```
  
   **–†–µ—à–µ–Ω–∏–µ:** –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –±—Ä–µ–π–∫–ø–æ–∏–Ω—Ç –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è.

> ‚ö†Ô∏è **–í–∞–∂–Ω–æ:** –û—Ç–ª–∞–¥–∫–∞ –≤—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã—Ö —Å–∏—Å—Ç–µ–º ‚Äî —ç—Ç–æ –∏—Å–∫—É—Å—Å—Ç–≤–æ. GDB –º–æ–∂–µ—Ç –ø–æ–∫–∞–∑–∞—Ç—å—Å—è —Å–ª–æ–∂–Ω—ã–º, –Ω–æ —ç—Ç–æ –º–æ—â–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç, –æ—Å–æ–±–µ–Ω–Ω–æ –≤ —Å–æ—á–µ—Ç–∞–Ω–∏–∏ —Å –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ —Å—Ä–µ–¥–∞–º–∏ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ (IDE).

### –û—Ç–ª–∞–¥–∫–∞ –≤ VS Code

Visual Studio Code –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è GDB, –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ —É–ø—Ä–æ—â–∞—é—â–∏–π –ø—Ä–æ—Ü–µ—Å—Å –æ—Ç–ª–∞–¥–∫–∏. –≠—Ç–æ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ –∫–æ–º–∞–Ω–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–µ `make gdb`, –≥–¥–µ –ø–æ–¥ –∫–∞–ø–æ—Ç–æ–º –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ—Ç –∂–µ –ø—Ä–æ—Ç–æ–∫–æ–ª GDB –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É –æ—Ç–ª–∞–¥–∫–∏, –Ω–æ –≤–º–µ—Å—Ç–æ CLI –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç—Å—è —É–¥–æ–±–Ω—ã–π –≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å.

#### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ VS Code

–î–ª—è —Ä–∞–±–æ—Ç—ã —Å QEMU –∏ GDB –Ω–µ–æ–±—Ö–æ–¥–∏–º–∞ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –≤ —Ñ–∞–π–ª–µ `launch.json`. VS Code –º–æ–∂–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –±–∞–∑–æ–≤—ã–π —à–∞–±–ª–æ–Ω —ç—Ç–æ–≥–æ —Ñ–∞–π–ª–∞ (F1 -> "Debug: Add Configuration"), –Ω–æ –µ–≥–æ –Ω—É–∂–Ω–æ –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥ –Ω–∞—à –ø—Ä–æ–µ–∫—Ç:

```json:.vscode/launch.json
{
    "configurations": [
        {
            "name": "QEMU ARM Debug",
            "type": "cppdbg",
            "request": "launch",
            "program": "${workspaceFolder}/test/elf/firmware.elf",
            "miDebuggerServerAddress": "localhost:3333",
            "cwd": "${workspaceFolder}/test/tests_stm32",
            "targetArchitecture": "arm",
            "MIMode": "gdb",
            "stopAtEntry": true
        }
    ]
}
```

#### –ü—Ä–æ—Ü–µ—Å—Å –æ—Ç–ª–∞–¥–∫–∏ –≤ VS Code

1. **–ó–∞–ø—É—Å—Ç–∏—Ç–µ QEMU –≤ —Ä–µ–∂–∏–º–µ –æ—Ç–ª–∞–¥–∫–∏:**
  
   ```bash
   ./start_qemu_gdb_mode.sh
   ```

2. **–û—Ç–∫—Ä–æ–π—Ç–µ VS Code –∏ –ø–µ—Ä–µ–π–¥–∏—Ç–µ –≤ —Ä–µ–∂–∏–º –æ—Ç–ª–∞–¥–∫–∏ (F5 –∏–ª–∏ Ctrl+Shift+D).** –ï—Å–ª–∏ QEMU –∑–∞–ø—É—â–µ–Ω, VS Code –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥–∫–ª—é—á–∏—Ç—Å—è –∫ –Ω–µ–º—É –∏ –æ—Ç–∫—Ä–æ–µ—Ç —Ñ–∞–π–ª—ã –ø—Ä–æ–µ–∫—Ç–∞, –Ω–∞ –∫–æ—Ç–æ—Ä—ã–µ —É–∫–∞–∑—ã–≤–∞–µ—Ç —Ä–µ–≥–∏—Å—Ç—Ä "PC". –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ C/C++ –¥–ª—è VS Code, –ø–æ–∑–≤–æ–ª—è—é—â–µ–µ –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏ —É–ø—Ä–∞–≤–ª—è—Ç—å —Å—Ç–µ–∫–æ–º –≤—ã–∑–æ–≤–æ–≤.

    ![VS Code Debug Overview](./vscode_debug_overview.png)

3. **–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ —Ç–æ—á–∫–∏ –æ—Å—Ç–∞–Ω–æ–≤–∞, –∫–ª–∏–∫–Ω—É–≤ —Å–ª–µ–≤–∞ –æ—Ç –Ω–æ–º–µ—Ä–∞ —Å—Ç—Ä–æ–∫–∏.** –ü–æ—è–≤–∏—Ç—Å—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∫—Ä–∞—Å–Ω–æ–π —Ç–æ—á–∫–∏.

    ![Setting Breakpoint in VS Code](./vscode_breakpoint.png)

4. **–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É "Start Debugging" (F5):**
  
   –ò—Å–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã –ø—Ä–µ—Ä–≤–µ—Ç—Å—è –ø—Ä–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ –±—Ä–µ–π–∫–ø–æ–∏–Ω—Ç–∞. –î–∞–ª–µ–µ –≤—ã –º–æ–∂–µ—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤—Å–µ –∫–æ–º–∞–Ω–¥—ã GDB —á–µ—Ä–µ–∑ –≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å VS Code.
  
   > üí° **–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ VS Code:**
   > - –í–∏–∑—É–∞–ª—å–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–æ—á–∫–∞–º–∏ –æ—Å—Ç–∞–Ω–æ–≤–∞
   > - –ü—Ä–æ—Å–º–æ—Ç—Ä –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
   > - –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –∫–æ–¥—É –≤–æ –≤—Ä–µ–º—è –æ—Ç–ª–∞–¥–∫–∏
   > - –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π —Ç–µ—Ä–º–∏–Ω–∞–ª –¥–ª—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç—ã —Å QEMU
   > - –£–¥–æ–±—Å—Ç–≤–æ —Ä–∞–±–æ—Ç—ã —Å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏ –∏ —Å—Ç–µ–∫–æ–º –≤—ã–∑–æ–≤–æ–≤
   > - –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –º–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–æ—Å—Ç–∏
   >
   > **–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –•–æ—Ç—è VS Code –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç —É–¥–æ–±–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å, –∑–Ω–∞–Ω–∏–µ –±–∞–∑–æ–≤—ã—Ö –∫–æ–º–∞–Ω–¥ GDB –æ—Å—Ç–∞—ë—Ç—Å—è –ø–æ–ª–µ–∑–Ω—ã–º –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ –Ω–∞ –º–µ–¥–ª–µ–Ω–Ω—ã—Ö –º–∞—à–∏–Ω–∞—Ö, –≥–¥–µ —á–∞—Å—Ç—ã–µ –∑–∞–ø—Ä–æ—Å—ã –∫ —Å–µ—Ä–≤–µ—Ä—É GDB –ø–æ —Å–µ—Ç–∏ –º–æ–≥—É—Ç —Å—É—â–µ—Å—Ç–≤–µ–Ω–Ω–æ –∑–∞–º–µ–¥–ª–∏—Ç—å –ø—Ä–æ—Ü–µ—Å—Å. –≠—Ç–æ —Ç–∞–∫–∂–µ –∫–ª—é—á–µ–≤–æ–π –Ω–∞–≤—ã–∫ –ø—Ä–∏ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ—Ü–µ—Å—Å–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –ø–æ–Ω–∏–º–∞–Ω–∏–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ GNU GCC.

### –ü—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ FreeRTOS –≤ VS Code

–û–¥–Ω–æ–π –∏–∑ —Å–∞–º—ã—Ö –º–æ—â–Ω—ã—Ö –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π –ø—Ä–∏ –æ—Ç–ª–∞–¥–∫–µ —è–≤–ª—è–µ—Ç—Å—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è —Ä–∞–±–æ—Ç—ã RTOS. –ù–∞—Å—Ç—Ä–æ–∏–º –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã, –ø–æ–∑–≤–æ–ª—è—é—â–∏–µ "–∑–∞–≥–ª—è–Ω—É—Ç—å –≤–Ω—É—Ç—Ä—å" –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã –∏ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–≤—è–∑—å —Å –Ω–∞—à–∏–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ–º, —á—Ç–æ–±—ã –ø–æ–Ω–∏–º–∞—Ç—å, –≥–¥–µ –æ–Ω–æ —Ç—Ä–∞—Ç–∏—Ç –≤—Ä–µ–º—è –∏ –ø–∞–º—è—Ç—å.

> üí° **–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –ü–æ–¥—Ä–æ–±–Ω–µ–µ –æ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—è—Ö –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏—è –º–æ–∂–Ω–æ –ø—Ä–æ—á–∏—Ç–∞—Ç—å –≤ [–æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ FreeRTOS](https://www.freertos.org/Documentation/02-Kernel/02-Kernel-features/08-Run-time-statistics).

#### –í–∫–ª—é—á–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ FreeRTOS

1. **–í STM32CubeMX –≤–∫–ª—é—á–∏—Ç–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –æ–ø—Ü–∏–∏ –¥–ª—è RTOS –Ω–∞ –æ—Å–Ω–æ–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ:**
  
   ![FreeRTOS Configuration in CubeMX](./rtos_view_config.png)
  
   > üí° **–í–∞–∂–Ω–æ:** –ù–µ –∑–∞–±—É–¥—å—Ç–µ –≤–∫–ª—é—á–∏—Ç—å `RECORD_STACK_HIGH_ADDRESS` –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Å—Ç–µ–∫–∞ –∫–∞–∂–¥—ã–º –ø–æ—Ç–æ–∫–æ–º.

#### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ç–∞–π–º–µ—Ä–∞ –¥–ª—è –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏—è

–î–ª—è –∏–∑–º–µ—Ä–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ø–æ—Ç–æ–∫–æ–≤ –Ω–µ–æ–±—Ö–æ–¥–∏–º —Ç–∞–π–º–µ—Ä. –ù–∞—Å—Ç—Ä–æ–∏–º TIM2 —Ç–∞–∫, —á—Ç–æ–±—ã –æ–Ω —Ä–∞–±–æ—Ç–∞–ª —á—É—Ç—å –±—ã—Å—Ç—Ä–µ–µ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ —Ç–∞–π–º–µ—Ä–∞, –Ω–æ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–µ–¥–ª–µ–Ω–Ω–æ, —á—Ç–æ–±—ã –¥–∞—Ç—å –æ–∫–æ–ª–æ 5 —Å–µ–∫—É–Ω–¥ –¥–æ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏—è:

![Timer Configuration](./tim2_config.png)

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è —Ñ—É–Ω–∫—Ü–∏–π –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π:**

–î–æ–±–∞–≤–∏–º –∏—Ö –≤ –∫–æ–Ω–µ—Ü —Ñ–∞–π–ª–∞ `tim.c`:

```c:test/tests_stm32/Core/Src/tim.c
unsigned long getRunTimeCounterValue(void) {
    return __HAL_TIM_GET_COUNTER(&htim2);
}

void configureTimerForRunTimeStats(void)
{
    // –¢–∞–π–º–µ—Ä —É–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω HAL, –ø—Ä–æ—Å—Ç–æ –∑–∞–ø—É—Å–∫–∞–µ–º
    HAL_TIM_Base_Start(&htim2);
}
```

> üí° **–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –≠—Ç–∏ —Ñ—É–Ω–∫—Ü–∏–∏ –æ–±—ä—è–≤–ª–µ–Ω—ã –∫–∞–∫ `weak` –≤ CMSIS-RTOS2. –ú—ã –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ–º —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—É—é —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å –Ω–∞—à–µ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π —Ç–∞–π–º–µ—Ä–∞.

#### RTOS Views –≤ VS Code

1. **–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ [RTOS Views](https://marketplace.visualstudio.com/items?itemName=mcu-debug.rtos-views).**
2. **–ó–∞–ø—É—Å—Ç–∏—Ç–µ –æ—Ç–ª–∞–¥–∫—É, –∫–∞–∫ –æ–ø–∏—Å–∞–Ω–æ —Ä–∞–Ω–µ–µ.**
3. **–î–∞–π—Ç–µ —Å–∏—Å—Ç–µ–º–µ –ø–æ—Ä–∞–±–æ—Ç–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥ (—á—Ç–æ–±—ã —É—Å–ø–µ–ª–∏ —Å–æ–∑–¥–∞—Ç—å—Å—è –ø–æ—Ç–æ–∫–∏).**
4. **–û—Ç–∫—Ä–æ–π—Ç–µ –≤–∫–ª–∞–¥–∫—É RTOS —Ä—è–¥–æ–º —Å —Ç–µ—Ä–º–∏–Ω–∞–ª–æ–º:**

   ![RTOS Views in VS Code](./rtos_views.png)

–í —Ç–∞–±–ª–∏—Ü–µ –≤—ã —É–≤–∏–¥–∏—Ç–µ:

- –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –ø–æ—Ç–æ–∫–æ–≤
- –°–æ—Å—Ç–æ—è–Ω–∏–µ –∫–∞–∂–¥–æ–≥–æ –ø–æ—Ç–æ–∫–∞ (–∞–∫—Ç–∏–≤–Ω—ã–π/–∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–π/–ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–π)
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å—Ç–µ–∫–∞
- –ü—Ä–æ—Ü–µ–Ω—Ç –≤—Ä–µ–º–µ–Ω–∏ CPU, –∑–∞—Ç—Ä–∞—á–µ–Ω–Ω–æ–≥–æ –Ω–∞ –∫–∞–∂–¥—ã–π –ø–æ—Ç–æ–∫

> ‚ö†Ô∏è **–õ–∏—á–Ω—ã–π –æ–ø—ã—Ç:** –ß–µ—Å—Ç–Ω–æ –≥–æ–≤–æ—Ä—è, —è –ø–æ—Ç—Ä–∞—Ç–∏–ª –Ω–µ–º–∞–ª–æ –≤—Ä–µ–º–µ–Ω–∏, –ø—ã—Ç–∞—è—Å—å –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å —ç—Ç–æ –≤—Å—ë –Ω–∞ —Ä–µ–∞–ª—å–Ω–æ–º –∂–µ–ª–µ–∑–µ, –∫–æ–≥–¥–∞ —Ç–æ–ª—å–∫–æ –Ω–∞—á–∏–Ω–∞–ª —Å–≤–æ–π –ø—É—Ç—å –≤ open-source —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ STM32. –ù–æ –æ–Ω–æ —Ç–æ–≥–æ —Å—Ç–æ–∏–ª–æ - —Ç–µ–ø–µ—Ä—å —É –º–µ–Ω—è –µ—Å—Ç—å –ø–æ–ª–Ω–æ–µ –ø–æ–Ω–∏–º–∞–Ω–∏–µ —Ä–∞–±–æ—Ç—ã —Å–∏—Å—Ç–µ–º—ã –≤ –ª—é–±–æ–π –º–æ–º–µ–Ω—Ç –æ—Ç–ª–∞–¥–∫–∏.

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–≠—Ç–∞ —Å—Ç–∞—Ç—å—è - –∫–æ–º–ø–∏–ª—è—Ü–∏—è –º–æ–µ–≥–æ –æ–ø—ã—Ç–∞ –∫–∞–∫ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞ –≤—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã—Ö —Å–∏—Å—Ç–µ–º. –†–∞–Ω—å—à–µ –º–æ—è —Ä–∞–±–æ—Ç–∞ –≤ –æ—Å–Ω–æ–≤–Ω–æ–º –∑–∞–∫–ª—é—á–∞–ª–∞—Å—å –≤–æ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–∏ —Å –∂–µ–ª–µ–∑–æ–º: –æ—Å—Ü–∏–ª–ª–æ–≥—Ä–∞—Ñ, –ø–∞—è–ª—å–Ω–∏–∫ –∏ –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã–µ –ø—Ä–æ—à–∏–≤–∫–∏ –æ—Ç–ª–∞–¥–æ—á–Ω—ã—Ö –ø–ª–∞—Ç. –ù–æ —Å–æ –≤—Ä–µ–º–µ–Ω–µ–º —è –ø–æ–Ω—è–ª, —á—Ç–æ –∫–ª—é—á –∫ –∫–æ–º—Ñ–æ—Ä—Ç–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ - —ç—Ç–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ.

> üí° **–ì–ª–∞–≤–Ω—ã–π —É—Ä–æ–∫:** –ö–æ–≥–¥–∞ –≤–∞—à —Ä–µ–¥–∞–∫—Ç–æ—Ä –±—ã—Å—Ç—Ä, –æ—Ç–ª–∞–¥–∫–∞ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –æ–¥–Ω–æ–π –∫–Ω–æ–ø–∫–æ–π, –∞ –ø—Ä–æ—Ü–µ—Å—Å –∏–¥–µ–Ω—Ç–∏—á–µ–Ω —á—Ç–æ –¥–ª—è –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ, —á—Ç–æ –¥–ª—è —Ä–µ–∞–ª—å–Ω–æ–≥–æ –∂–µ–ª–µ–∑–∞ - —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–µ–≤—Ä–∞—â–∞–µ—Ç—Å—è –≤ —É–¥–æ–≤–æ–ª—å—Å—Ç–≤–∏–µ!

–í —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–º –º–∏—Ä–µ, –≥–¥–µ —É–¥–∞–ª–µ–Ω–Ω–∞—è —Ä–∞–±–æ—Ç–∞ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –Ω–æ—Ä–º–æ–π, –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —ç–º—É–ª—è—Ü–∏–∏ –∂–µ–ª–µ–∑–∞ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –Ω–æ–≤—ã–µ –≥–æ—Ä–∏–∑–æ–Ω—Ç—ã.

### –ß—Ç–æ –¥–∞–ª—å—à–µ?

–ù–∞–¥–µ—é—Å—å, —ç—Ç–æ –Ω–µ–±–æ–ª—å—à–æ–µ –≤–≤–µ–¥–µ–Ω–∏–µ –≤ –º–∏—Ä open-source –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤, —ç–º—É–ª—è—Ü–∏–∏, –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ –∏ –æ—Ç–ª–∞–¥–∫–∏ –Ω–∞ –ø—Ä–∏–º–µ—Ä–µ STM32 –∏ –º–æ–µ–π –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –±—ã–ª–æ –ø–æ–ª–µ–∑–Ω—ã–º. –í–µ—Å—å –∫–æ–¥ –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ–¥ MIT –ª–∏—Ü–µ–Ω–∑–∏–µ–π - –Ω–µ —Å—Ç–µ—Å–Ω—è–π—Ç–µ—Å—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –µ–≥–æ –≤ —Å–≤–æ–∏—Ö –ø—Ä–æ–µ–∫—Ç–∞—Ö –∏ —Å–æ–∑–¥–∞–≤–∞—Ç—å —Ñ–æ—Ä–∫–∏! ([GitHub](https://github.com/AleksandrVin/logging_cmsis_rtos2))

> ‚ö†Ô∏è **–ù–∞–ø–æ—Å–ª–µ–¥–æ–∫:** –ù–µ –±–æ–π—Ç–µ—Å—å —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –∏ —Å–æ–∑–¥–∞–≤–∞—Ç—å —Å–≤–æ–∏ —Å–∫—Ä–∏–ø—Ç—ã –¥–ª—è –∫–æ–º—Ñ–æ—Ä—Ç–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏!
